<odoo>
    <template id="report_fuel_log_pdf">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">

                    <!-- Group logs by vehicle -->
                    <t t-set="logs_by_vehicle" t-value="{}"/>
                    <t t-foreach="docs" t-as="log">
                        <t t-set="vehicle" t-value="log.vehicle_id.name or 'Unknown Vehicle'"/>
                        <t t-set="logs_by_vehicle[vehicle]" t-value="logs_by_vehicle.get(vehicle, []) + [log]"/>
                    </t>

                    <!-- Vehicle grouped reports -->
                    <t t-foreach="logs_by_vehicle.items()" t-as="vehicle_logs">
                        <div class="page">
                            <h2>Fuel Logs - <t t-esc="vehicle_logs[0]"/></h2>
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Driver</th>
                                        <th>Trip</th>
                                        <th>Est. Litres</th>
                                        <th>Actual Litres</th>
                                        <th>Variance</th>
                                        <th>Cost/Litre</th>
                                        <th>Est. Cost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-set="sum_est_litres" t-value="0.0"/>
                                    <t t-set="sum_actual_litres" t-value="0.0"/>
                                    <t t-set="sum_variance" t-value="0.0"/>
                                    <t t-set="sum_est_cost" t-value="0.0"/>
                                    <t t-foreach="vehicle_logs[1]" t-as="log">
                                        <tr>
                                            <td><t t-esc="log.date"/></td>
                                            <td><t t-esc="log.driver_id.name or ''"/></td>
                                            <td><t t-esc="log.trip_id.name or ''"/></td>
                                            <td><t t-esc="log.litres_estimated"/></td>
                                            <td><t t-esc="log.liter"/></td>
                                            <td><t t-esc="log.fuel_variance"/></td>
                                            <td><t t-esc="log.cost_per_litre"/></td>
                                            <td><t t-esc="log.total_cost_estimated"/></td>
                                        </tr>
                                        <t t-set="sum_est_litres" t-value="sum_est_litres + (log.litres_estimated or 0.0)"/>
                                        <t t-set="sum_actual_litres" t-value="sum_actual_litres + (log.liter or 0.0)"/>
                                        <t t-set="sum_variance" t-value="sum_variance + (log.fuel_variance or 0.0)"/>
                                        <t t-set="sum_est_cost" t-value="sum_est_cost + (log.total_cost_estimated or 0.0)"/>
                                    </t>
                                </tbody>
                            </table>
                            <p><strong>Total Estimated Litres:</strong> <t t-esc="sum_est_litres"/></p>
                            <p><strong>Total Actual Litres:</strong> <t t-esc="sum_actual_litres"/></p>
                            <p><strong>Fuel Variance:</strong> <t t-esc="sum_variance"/></p>
                            <p><strong>Total Estimated Cost:</strong> <t t-esc="sum_est_cost"/></p>
                        </div>
                    </t>

                    <!-- Summary for all -->
                    <t t-if="len(logs_by_vehicle) > 1">
                        <t t-set="grand_est" t-value="0.0"/>
                        <t t-set="grand_act" t-value="0.0"/>
                        <t t-set="grand_var" t-value="0.0"/>
                        <t t-set="grand_cost" t-value="0.0"/>
                        <t t-foreach="docs" t-as="log">
                            <t t-set="grand_est" t-value="grand_est + (log.litres_estimated or 0.0)"/>
                            <t t-set="grand_act" t-value="grand_act + (log.liter or 0.0)"/>
                            <t t-set="grand_var" t-value="grand_var + (log.fuel_variance or 0.0)"/>
                            <t t-set="grand_cost" t-value="grand_cost + (log.total_cost_estimated or 0.0)"/>
                        </t>

                        <div class="page">
                            <h2>Summary: All Vehicles</h2>
                            <p><strong>Total Estimated Litres:</strong> <t t-esc="grand_est"/></p>
                            <p><strong>Total Actual Litres:</strong> <t t-esc="grand_act"/></p>
                            <p><strong>Total Fuel Variance:</strong> <t t-esc="grand_var"/></p>
                            <p><strong>Total Estimated Cost:</strong> <t t-esc="grand_cost"/></p>
                        </div>
                    </t>
                </div>
            </t>
        </t>
    </template>
</odoo>
